name: 建置 Android APK

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: 簽出程式碼
        uses: actions/checkout@v4

      - name: 設定 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: 設定 pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: 安裝依賴
        run: pnpm install --frozen-lockfile

      - name: 建置 Next.js 應用
        run: pnpm build

      - name: 設定 JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: 設定 Android SDK
        uses: android-actions/setup-android@v3

      - name: 接受 Android SDK 授權
        run: |
          echo "=== 接受 Android SDK 授權 ==="
          mkdir -p $ANDROID_HOME/licenses
          echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
          echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
          echo "d56f5187479bea82b38e8a18a2dd3ac60e6b99a6" > $ANDROID_HOME/licenses/android-adt-license
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" 2>&1 | head -20 || true

      - name: 安裝 Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: 啟動靜態伺服器
        run: |
          cd out
          npx serve -l 3000 &
          echo $! > ../server.pid
          sleep 5
          if curl -f http://localhost:3000/Teditor/ > /dev/null 2>&1; then
            echo "✓ 伺服器已啟動"
          else
            echo "✗ 伺服器啟動失敗"
            exit 1
          fi

      - name: 初始化 Bubblewrap 專案
        timeout-minutes: 40
        run: |
          echo "=== 初始化 Bubblewrap ==="
          timeout 30m sh -c 'yes Y | bubblewrap init --manifest http://localhost:3000/Teditor/manifest.json --directory .twa-project' || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 124 ]; then
              echo "⚠ Bubblewrap 初始化超時"
            else
              echo "✗ Bubblewrap 初始化失敗"
              exit 1
            fi
          }
          if [ ! -d ".twa-project" ]; then
            echo "✗ 錄目未建立"
            exit 1
          fi
          echo "✓ Bubblewrap 專案已初始化"

      - name: 優化 Gradle 配置
        run: |
          if [ ! -f ".twa-project/gradle.properties" ]; then
            touch .twa-project/gradle.properties
          fi
          cat >> .twa-project/gradle.properties << 'EOF'
          org.gradle.jvmargs=-Xmx1024m -XX:MaxMetaspaceSize=256m
          org.gradle.daemon=false
          org.gradle.parallel=true
          org.gradle.workers.max=2
          EOF

      - name: 建置 Android APK
        run: |
          cd .twa-project
          ./gradlew build --info --stacktrace || exit 1

      - name: 停止伺服務器
        if: always()
        run: |
          if [ -f "server.pid" ]; then
            kill $(cat server.pid) 2>/dev/null || true
            rm server.pid
          fi

      - name: 查找 APK
        if: success()
        run: |
          mkdir -p apk-output
          find .twa-project -name "*.apk" -type f -exec cp {} apk-output/ \;
          if [ -z "$(ls -A apk-output/)" ]; then
            echo "✗ 未找到 APK"
            exit 1
          fi

      - name: 上傳 APK 工件
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: TextEdit-APK
          path: apk-output/
          if-no-files-found: error
